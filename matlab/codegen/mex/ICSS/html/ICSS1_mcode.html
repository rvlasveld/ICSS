<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,1" id="srcline1">  1</a></span><span class="line"><span class="keyword">function</span> [ <span class="var type1" id="S2T23U3">change_points</span> ] = ICSS( <span class="var type1" id="S3T1U6">data</span> )</span></span>
<span class="srcline"><span class="lineno"><a href="1,2" id="srcline2">  2</a></span><span class="line"><span class="comment">%#codegen</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,3" id="srcline3">  3</a></span><span class="line"><span class="comment">% ICSS Run the 'Iterative Cumulative Sums of Squares' algorithm</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,4" id="srcline4">  4</a></span><span class="line"><span class="comment">%   Based on 'Use of Cumulative Sums of Squares for Retrospective Detection</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,5" id="srcline5">  5</a></span><span class="line"><span class="comment">%   of Changes of Variance', by Inclan and Tiao, 1994</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,6" id="srcline6">  6</a></span><span class="line"><span class="comment">%   input: raw data</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,7" id="srcline7">  7</a></span><span class="line"><span class="comment">%   output: vector of change-points</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,8" id="srcline8">  8</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,9" id="srcline9">  9</a></span><span class="line">    <span class="comment">% Perform first two steps of the algorithm (which is recursive)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,10" id="srcline10"> 10</a></span><span class="line">    <span class="var type2" id="S4T0U9">potential_change_points</span> = <span class="message error" id="M1F1C"><span class="fcn" id="F2N4:B11">ICSS_step_1_and_2</span>(<span class="var type1" id="S3T1U12">data</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,11" id="srcline11"> 11</a></span><span class="line">    <span class="var type2" id="S4T0U15">potential_change_points</span> = unique([<span class="mxinfo" id="T2:U4">0</span>, sort(<span class="var type2" id="S4T0U23"><span class="message error" id="M2F1C">potential_change_points</span></span>), length(<span class="var type2" id="S3T0U26">data</span>)]);</span></span>
<span class="srcline"><span class="lineno"><a href="1,12" id="srcline12"> 12</a></span><span class="line">   </span></span>
<span class="srcline"><span class="lineno"><a href="1,13" id="srcline13"> 13</a></span><span class="line">    <span class="comment">% Step 3: check each potential change point</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,14" id="srcline14"> 14</a></span><span class="line">    <span class="mxinfo" id="T5:U5"><span class="var type1" id="S9T5U29">converged</span> = <span class="mxinfo" id="T5:U7">false</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,15" id="srcline15"> 15</a></span><span class="line">    <span class="keyword">while</span> <span class="mxinfo" id="T5:U8">~<span class="var type1" id="S9T5U34">converged</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,16" id="srcline16"> 16</a></span><span class="line">        <span class="comment">% Store the new retrieved change points of this loop</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,17" id="srcline17"> 17</a></span><span class="line">        <span class="mxinfo" id="T18:U10"><span class="var type1" id="S11T18U37">new_cps</span> = <span class="mxinfo" id="T18:U12">[]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,18" id="srcline18"> 18</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,19" id="srcline19"> 19</a></span><span class="line">        <span class="comment">% check every potential change point by inspecting from and to </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,20" id="srcline20"> 20</a></span><span class="line">        <span class="comment">% the surrounding change points</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,21" id="srcline21"> 21</a></span><span class="line">        <span class="keyword">for</span> <span class="var type0" id="S12T0U42">i</span>=<span class="mxinfo" id="T2:U13">2</span>:(length(<span class="var type2" id="S4T0U49"><span class="message error" id="M3F1C">potential_change_points</span></span>)-1)</span></span>
<span class="srcline"><span class="lineno"><a href="1,22" id="srcline22"> 22</a></span><span class="line">            <span class="var type0" id="S13T0U53">from</span>    = <span class="var type2" id="S4T0U56"><span class="message error" id="M4F1C">potential_change_points</span></span>(<span class="var type0" id="S12T0U58">i</span>-1)+1;</span></span>
<span class="srcline"><span class="lineno"><a href="1,23" id="srcline23"> 23</a></span><span class="line">            <span class="var type0" id="S14T0U63">to</span>      = <span class="var type2" id="S4T0U65"><span class="message error" id="M5F1C">potential_change_points</span></span>(<span class="var type0" id="S12T0U67">i</span>+1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,24" id="srcline24"> 24</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="1,25" id="srcline25"> 25</a></span><span class="line">            <span class="comment">% Calculate the Dk and M again for this section of the data</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,26" id="srcline26"> 26</a></span><span class="line">            <span class="var type0" id="S15T0U71">Dk</span>                  = CenteredCusumValues(<span class="var type1" id="S3T1U75">data</span>(<span class="var type0" id="S13T0U77"><span class="message error" id="M6F1C">from</span></span>:<span class="var type0" id="S14T0U78">to</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,27" id="srcline27"> 27</a></span><span class="line">            [<span class="var type0" id="S17T0U82"><span class="message error" id="M8F1C">exceeds</span></span>, <span class="var type0" id="S18T0U83"><span class="message error" id="M9F1C">position</span></span>] = check_critical_value(<span class="var type0" id="S15T0U86"><span class="message error" id="M7F1C">Dk</span></span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,28" id="srcline28"> 28</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="1,29" id="srcline29"> 29</a></span><span class="line">            <span class="keyword">if</span> <span class="var type0" id="S17T0U89"><span class="message error" id="M10F1C">exceeds</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,30" id="srcline30"> 30</a></span><span class="line">                <span class="comment">% Keep this (new) change point</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,31" id="srcline31"> 31</a></span><span class="line">                <span class="var type2" id="S11T0U93">new_cps</span>(end+1) = <span class="var type0" id="S13T0U99"><span class="message error" id="M11F1C">from</span></span> + <span class="var type0" id="S18T0U100">position</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,32" id="srcline32"> 32</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,33" id="srcline33"> 33</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,34" id="srcline34"> 34</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,35" id="srcline35"> 35</a></span><span class="line">        <span class="mxinfo" id="T11:U15"><span class="var type1" id="S11T11U103">new_cps</span> = <span class="mxinfo" id="T11:U17">[<span class="mxinfo" id="T2:U18">0</span>, <span class="mxinfo" id="T18:U19">sort(<span class="var type1" id="S11T18U109">new_cps</span>)</span>, <span class="mxinfo" id="T2:U21">length(<span class="var type1" id="S3T1U112">data</span>)</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,36" id="srcline36"> 36</a></span><span class="line">        <span class="var type2" id="S9T0U115">converged</span> = is_converged(<span class="var type2" id="S4T0U118"><span class="message error" id="M12F1C">potential_change_points</span></span>, <span class="var type2" id="S11T0U119">new_cps</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,37" id="srcline37"> 37</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,38" id="srcline38"> 38</a></span><span class="line">        <span class="keyword">if</span> <span class="mxinfo" id="T5:U23">~<span class="var type1" id="S9T5U123">converged</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,39" id="srcline39"> 39</a></span><span class="line">            <span class="mxinfo" id="T11:U25"><span class="var type1" id="S4T11U126">potential_change_points</span> = <span class="var type1" id="S11T11U127">new_cps</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,40" id="srcline40"> 40</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,41" id="srcline41"> 41</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,42" id="srcline42"> 42</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,43" id="srcline43"> 43</a></span><span class="line">    <span class="comment">% Remove additional 0 and end change point</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,44" id="srcline44"> 44</a></span><span class="line">    <span class="mxinfo" id="T23:U28"><span class="var type1" id="S2T23U130">change_points</span> = <span class="mxinfo" id="T23:U30"><span class="var type1" id="S4T11U132">potential_change_points</span>(<span class="mxinfo" id="T23:U32"><span class="mxinfo" id="T2:U33">2</span>:<span class="mxinfo" id="T2:U34">end-1</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,45" id="srcline45"> 45</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,46" id="srcline46"> 46</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,47" id="srcline47"> 47</a></span><span class="line"></span></span>
</pre>
